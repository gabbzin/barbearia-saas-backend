generator client {
  provider     = "prisma-client-js"
  engineType   = "library"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String        @id @default(uuid())
  name             String
  email            String        @unique
  emailVerified    Boolean       @default(false)
  role             userRole      @default(USER)
  passwordHash     String?
  image            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @default(now()) @updatedAt
  stripeCustomerId String?
  barberProfile    Barber?       @relation("BarberAccount")
  bookings         Booking[]
  accounts         Account[]
  sessions         Session[]
  subscription     Subscription?

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Barber {
  id             String          @id @default(uuid())
  imageUrl       String          @default("https://3tlh7aktl6.ufs.sh/f/tcFRjMXVSkQ0Asb1IxZDwZ30bIph8P2qjXfOcVJmTvFtnMxi")
  phone          String[]
  userId         String?         @unique
  user           User?           @relation("BarberAccount", fields: [userId], references: [id])
  services       BarberService[]
  bookings       Booking[]
  disponibility  Disponibility[]
  exceptionDates ExceptionDate[]

  @@index([userId])
}

model BarberService {
  id                String    @id @default(uuid())
  name              String
  description       String
  imageUrl          String
  priceInCents      Int
  barberId          String
  durationInMinutes Int       @default(30)
  barber            Barber    @relation(fields: [barberId], references: [id])
  bookings          Booking[]

  @@index([barberId])
}

model Subscription {
  id                   String              @id @default(uuid())
  stripeCustomerId     String?
  stripeSubscriptionId String?             @unique
  periodStart          DateTime?
  periodEnd            DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  cancelAtPeriodEnd    Boolean?            @default(false)
  seats                Int?
  userId               String              @unique
  planId               String?
  status               SubscriptionStatus? @default(INCOMPLETE)
  plan                 Plan?               @relation(fields: [planId], references: [id])
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("subscription")
}

model Plan {
  id            String         @id
  name          String
  description   String
  priceInCents  Int
  stripePriceId String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]
}

model Booking {
  id                   String        @id @default(uuid())
  date                 DateTime      @db.Timestamptz(6)
  serviceId            String
  userId               String
  barberId             String
  userSubscriptionId   String?
  paidWithSubscription Boolean       @default(false)
  stripeChargeId       String?       @unique
  stripeEventId        String?       @unique
  cancelledAt          DateTime?     @db.Timestamptz(6)
  createdAt            DateTime      @default(now())
  status               BookingStatus @default(SCHEDULED)
  updatedAt            DateTime      @updatedAt
  priceInCents         Int
  barber               Barber        @relation(fields: [barberId], references: [id])
  service              BarberService @relation(fields: [serviceId], references: [id])
  user                 User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([barberId, date])
  @@index([status])
}

model Disponibility {
  id        String @id @default(uuid())
  barberId  String
  startTime String
  endTime   String
  dayOfWeek Int
  barber    Barber @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@unique([barberId, dayOfWeek])
}

model ExceptionDate {
  id        String  @id @default(uuid())
  barberId  String
  isClosed  Boolean @default(true)
  date      String?
  startTime String?
  endTime   String?
  barber    Barber  @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@index([barberId])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  INCOMPLETE
}

enum userRole {
  USER
  ADMIN
  BARBER
}

enum BookingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum DiaSemana {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}
